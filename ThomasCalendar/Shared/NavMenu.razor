@using System.ComponentModel
@using ThomasCalendar.Business
@using ThomasCalendar.Models
@inject Blazored.LocalStorage.ILocalStorageService localStore
@inject IJSRuntime JSRuntime;
@inject DateState DateState

<div class="top-row pl-4 navbar navbar-dark">
    <a class="navbar-brand" href="">Bad Habit Tracker</a>
    <button class="navbar-toggler" @onclick="ToggleNavMenu">
        <span class="navbar-toggler-icon"></span>
    </button>
</div>

<div class="@NavMenuCssClass" @onclick="ToggleNavMenu">
    <ul class="nav flex-column">
        @*<li class="nav-item px-3">
                            <NavLink class="nav-link" href="home" Match="NavLinkMatch.All">
                                <span class="oi oi-home" aria-hidden="true"></span> Home
                            </NavLink>
                        </li>
                        <li class="nav-item px-3">
                            <NavLink class="nav-link" href="counter">
                                <span class="oi oi-plus" aria-hidden="true"></span> Counter
                            </NavLink>
                        </li>
                        <li class="nav-item px-3">
                            <NavLink class="nav-link" href="fetchdata">
                                <span class="oi oi-list-rich" aria-hidden="true"></span> Fetch data
                            </NavLink>
                        </li>
            >*@
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <span class="oi oi-calendar" aria-hidden="true"></span> Calendar
            </NavLink>
        </li>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="events">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Events
            </NavLink>
        </li>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="settings">
                <span class="oi oi-vertical-align-center" aria-hidden="true"></span> Settings
            </NavLink>
        </li>
    </ul>

    @* Nav Bottom Card *@
    <div id="navInfoCard">
        <div class="card" style="position: absolute; bottom: 100px; width: 100%; width: 220px; right: 15px">
            <div class="card-body">

                @if (DateState.Container != null)
                {
                    <div>Last Relapse: @(DateState.GetLastRelapse()?.ToShortDateString() ?? "n/a")</div>
                    <div>@(((todaysDate.Date - DateState.GetLastRelapse()?.Date)?.TotalDays - 1) ?? 0) days since last relapse</div>
                }
            </div>
        </div>

        <div style="position: absolute; bottom: 30px; width: 100%; color: white; text-align: center">
            Bad Habit Tracker 2020 <br /> Thomas Rosales
        </div>

    </div>

</div>



@code {

    private bool collapseNavMenu = true;
    private string NavMenuCssClass => collapseNavMenu ? "collapse" : null;

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }


    private CalendarContainer Container = new CalendarContainer();
    private List<Day> Habits = new List<Day>();
    public DateTime todaysDate = DateTime.Now;


    protected override async Task OnInitializedAsync()
    {
        Container = await localStore.GetItemAsync<CalendarContainer>("Calendar");
        DateState.UpdateCalendar(Container);
        string localDate = await JSRuntime.InvokeAsync<string>("GetLocalDate");
        todaysDate = DateTime.Parse(localDate);

        var helperFunctions = new HelperFunctions();

        if (DateState.Container != null)
        {
            helperFunctions.CalculateBadDays(Habits, DateState.Container);
        }
        else
        {
            DateState.UpdateCalendar(new CalendarContainer());
        }
    }


    protected override void OnInitialized()
    {
        DateState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        DateState.OnChange -= StateHasChanged;
    }
}
